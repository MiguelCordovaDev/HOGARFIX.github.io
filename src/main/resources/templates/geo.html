<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitar Servicio - HarmonyTech</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        /* Estilo obligatorio para que el mapa se muestre */
        #map {
            height: 350px;
            width: 100%;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center bg-gray-100 p-4">

    <div class="w-full max-w-4xl bg-white p-8 rounded-xl shadow-2xl border border-gray-200">
        <h2 class="text-3xl font-bold text-center text-indigo-700 mb-6">Solicitar un Nuevo Servicio</h2>
        <p class="text-center text-gray-600 mb-8">Cuéntanos sobre el problema y marca la ubicación exacta en el mapa.</p>

        <!-- Formulario de Solicitud -->
        <!-- Asume que el modelo a llenar es un objeto 'servicio' -->
        <form th:action="@{/servicios/crear}" th:object="${servicio}" method="post" class="space-y-6">

            <!-- SECCIÓN 1: DETALLES DEL PROBLEMA -->
            <fieldset class="border p-4 rounded-lg shadow-inner">
                <legend class="text-xl font-semibold text-gray-700 px-2">Detalles del Trabajo</legend>
                
                <!-- Categoría (Dropdown) -->
                <div>
                    <label for="categoria" class="block text-sm font-medium text-gray-700 mb-1">Categoría del Técnico</label>
                    <!-- Nota: La lista de categorías (plomería, electricidad) debe ser cargada desde el controlador -->
                    <select id="categoria" th:field="*{categoriaId}" required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                        <option value="">Selecciona una categoría</option>
                        <option th:each="cat : ${categorias}" th:value="${cat.id}" th:text="${cat.nombre}"></option>
                    </select>
                </div>

                <!-- Descripción -->
                <div>
                    <label for="descripcion" class="block text-sm font-medium text-gray-700 mb-1">Descripción Detallada del Problema</label>
                    <textarea id="descripcion" th:field="*{descripcion}" rows="4" required
                              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                              placeholder="Ej: El inodoro pierde agua constantemente, o un interruptor de luz no funciona."></textarea>
                </div>
            </fieldset>
            
            <!-- SECCIÓN 2: UBICACIÓN Y MAPA -->
            <fieldset class="border p-4 rounded-lg shadow-inner">
                <legend class="text-xl font-semibold text-gray-700 px-2">Ubicación del Servicio</legend>

                <!-- Campo de Dirección (opcional, el mapa es el principal) -->
                <div>
                    <label for="direccion" class="block text-sm font-medium text-gray-700 mb-1">Dirección de Referencia</label>
                    <input type="text" id="direccion" th:field="*{direccion}" required
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150"
                           placeholder="Ej: Av. Las Flores 123, Urb. San Juan">
                </div>
                
                <p class="mt-4 mb-2 text-gray-600 text-sm">
                    Haz clic en el mapa para marcar la ubicación exacta del servicio.
                </p>

                <!-- Contenedor del Mapa -->
                <div id="map"></div>

                <!-- Campos Ocultos para Guardar las Coordenadas -->
                <input type="hidden" id="latitud" th:field="*{latitud}" required>
                <input type="hidden" id="longitud" th:field="*{longitud}" required>

            </fieldset>

            <!-- Botón de Envío -->
            <button type="submit"
                    class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out">
                Enviar Solicitud
            </button>
        </form>

    </div>

    <!-- Script de Inicialización del Mapa de Google Maps -->
    <script>
        let map;
        let marker;
        const defaultLocation = { lat: -12.0464, lng: -77.0428 }; // Lima, Perú como centro por defecto

        function initMap() {
            // Inicializa el mapa
            map = new google.maps.Map(document.getElementById("map"), {
                center: defaultLocation,
                zoom: 12,
                mapTypeControl: false,
                streetViewControl: false,
            });

            // Crea el marcador (inicialmente en el centro)
            marker = new google.maps.Marker({
                position: defaultLocation,
                map: map,
                draggable: true // Permite arrastrar el marcador
            });

            // Establece las coordenadas iniciales en los campos ocultos
            document.getElementById('latitud').value = defaultLocation.lat;
            document.getElementById('longitud').value = defaultLocation.lng;


            // Listener para el arrastre del marcador
            google.maps.event.addListener(marker, 'dragend', function(event) {
                updateCoordinates(event.latLng.lat(), event.latLng.lng());
            });

            // Listener para el click en el mapa
            map.addListener("click", (e) => {
                placeMarker(e.latLng, map);
            });
            
            // Función para ubicar el marcador en el click
            function placeMarker(latLng, map) {
                marker.setPosition(latLng);
                updateCoordinates(latLng.lat(), latLng.lng());
            }
        }
        
        // Función para actualizar los campos de formulario
        function updateCoordinates(lat, lng) {
            document.getElementById('latitud').value = lat.toFixed(6);
            document.getElementById('longitud').value = lng.toFixed(6);
            console.log(`Coordenadas actualizadas: Lat ${lat.toFixed(6)}, Lng ${lng.toFixed(6)}`);
        }

    </script>

    
    <script async src="https://maps.googleapis.com/maps/api/js?key=&callback=initMap"></script>

</body>
</html>