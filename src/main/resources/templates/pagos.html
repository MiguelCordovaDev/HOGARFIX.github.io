<!doctype html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Pagos · HogarFix</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:24px;background:#f8fafc;color:#0f172a}</style>
</head>
<body>
  <main class="max-w-6xl mx-auto grid gap-6 grid-cols-1 lg:grid-cols-3 items-start" th:with="pago=${#lists.isEmpty(pagos) ? null : pagos[0]}">
    <!-- MAIN -->
    <section class="lg:col-span-2 space-y-6">
      <header class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-semibold text-slate-800">HogarFix · Pagos</h1>
          <!doctype html>
          <html lang="es" xmlns:th="http://www.thymeleaf.org">
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width,initial-scale=1">
            <title>Pagos · HogarFix</title>
            <script src="https://cdn.tailwindcss.com"></script>
            <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
            <style>
              body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:24px;background:#f8fafc;color:#0f172a}
              .glass{background:rgba(255,255,255,0.85);backdrop-filter:blur(6px);border-radius:12px}
              .spinner{border:3px solid rgba(0,0,0,0.06);border-top-color:#06b6d4;border-radius:999px;width:14px;height:14px;animation:spin .9s linear infinite}
              @keyframes spin{to{transform:rotate(360deg)}}
              .method-active{box-shadow:0 6px 18px rgba(14,165,233,0.12);border-color:rgba(14,165,233,0.6)}
              .text-danger{color:#dc2626}
              .toast{position:fixed;right:20px;bottom:20px;background:#16a34a;color:white;padding:10px 14px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.12);display:flex;align-items:center;gap:8px}
            </style>
          </head>
          <body>
            <main class="max-w-6xl mx-auto grid gap-6 grid-cols-1 lg:grid-cols-3 items-start" th:with="pago=${#lists.isEmpty(pagos) ? null : pagos[0]}">
              <section class="lg:col-span-2 space-y-6">
                <header class="flex items-center justify-between">
                  <div>
                   
                    <p class="text-sm text-slate-500 mt-1">Paga tu servicio</p>
                  </div>
                  <div class="text-right">
                    <div class="text-xs text-slate-500">Estado</div>
                    <div id="authStatus" class="text-sm font-medium text-amber-600">Autenticado</div>
                  </div>
                </header>

                <section class="glass p-6 bg-white rounded-lg shadow">
                  <div class="flex items-start justify-between gap-4">
                    <div>
                      <h2 class="text-lg font-semibold text-slate-800">Formulario de pago</h2>
                      <p class="text-sm text-slate-500 mt-1">
                      · Categoría: <strong id="svcCategory" th:text="${pago != null && pago.categoriaNombre != null ? pago.categoriaNombre : '—'}">Categoría</strong>
                      · Técnico: <strong id="svcTech" th:text="${pago != null && pago.tecnicoNombres != null ? (pago.tecnicoNombres + ' ' + pago.tecnicoApellidoPaterno) : '—'}">Técnico</strong></p>
                    </div>
                    <div class="text-right">
                      <div class="text-sm text-slate-500">Total</div>
                      <div id="svcCost" class="text-lg font-bold text-slate-800" th:text="${pago != null ? ('S/ ' + pago.monto) : 'S/ 0.00'}">S/ 0.00</div>
                      <div class="text-xs text-slate-400 mt-1">Fecha: <span id="svcDate" th:text="${pago != null && pago.servicioFechaFinalizacion != null ? #temporals.format(pago.servicioFechaFinalizacion,'dd/MM/yyyy') : ''}"></span></div>
                    </div>
                  </div>

                  <form id="paymentForm" class="mt-6 space-y-4" autocomplete="off" novalidate>
                    <input type="hidden" id="currentPagoId" th:value="${pago != null ? pago.idPago : ''}">

                    <div>
                      <label class="block text-sm text-slate-600 mb-1">Nombre del cliente</label>
                      <input id="clienteNombre" name="clienteNombre" class="w-full p-3 rounded-md border border-slate-200" placeholder="Ej. María Pérez" th:value="${cliente != null ? cliente.nombres + ' ' + cliente.apellidoPaterno : ''}">
                      <p id="errNombre" class="text-xs text-danger mt-1 hidden"></p>
                    </div>

                    <div>
                      <label class="block text-sm text-slate-600 mb-1">Monto (S/)</label>
                      <input id="amountInput" name="amount" type="text" inputmode="decimal" pattern="[0-9]+([.,][0-9]{1,2})?" class="w-full p-3 rounded-md border border-slate-200" th:value="${pago != null ? pago.monto : '0.00'}">
                      <p id="errAmount" class="text-xs text-danger mt-1 hidden"></p>
                    </div>

                    <div>
                      <label class="block text-sm text-slate-600 mb-2">Método de pago</label>
                      <div class="flex gap-3">
                        <button type="button" data-method="tarjeta" class="method-btn flex-1 px-4 py-2 rounded-md border border-slate-200 bg-white text-sm font-medium">Tarjeta</button>
                        <button type="button" data-method="yape" class="method-btn flex-1 px-4 py-2 rounded-md border border-slate-200 bg-white text-sm font-medium">Yape (QR)</button>
                      </div>
                    </div>

                    <!-- Tarjeta -->
                    <div id="panel-tarjeta" class="method-panel mt-2 space-y-3">
                      <div>
                          <label class="text-sm text-slate-600 mb-1 block">Número de tarjeta (16 dígitos)</label>
                          <input id="cardNumber" placeholder="Ej. 1234 5678 9012 3456" class="w-full p-3 rounded-md border border-slate-200" inputmode="numeric" maxlength="16" />
                          <p id="errCard" class="text-xs text-danger mt-1 hidden"></p>
                        </div>
                      <div class="flex gap-3">
                        <div class="flex-1">
                          <label class="text-sm text-slate-600 mb-1 block">Vencimiento (MM/AA)</label>
                          <input id="cardExpiry" placeholder="MM/AA" class="w-full p-3 rounded-md border border-slate-200" maxlength="5" />
                          <p id="errExpiry" class="text-xs text-danger mt-1 hidden"></p>
                        </div>
                        <div style="width:120px">
                          <label class="text-sm text-slate-600 mb-1 block">CVV</label>
                          <input id="cardCvv" placeholder="123" class="w-full p-3 rounded-md border border-slate-200" maxlength="4" inputmode="numeric"/>
                          <p id="errCvv" class="text-xs text-danger mt-1 hidden"></p>
                        </div>
                      </div>
                      <div class="text-sm text-slate-500">Últimos 4: <span id="cardLast4">—</span></div>
                    </div>

                    <!-- Yape QR (solo muestra QR, sin funcionalidad real) -->
                    <div id="panel-yape" class="method-panel mt-2 space-y-3 hidden">
                      <div>
                        <label class="text-sm text-slate-600 mb-1 block">Número Yape (Celular)</label>
                        <input id="yapePhone" placeholder="9XXXXXXXX" class="w-full p-3 rounded-md border border-slate-200" inputmode="numeric" maxlength="9" />
                        <p id="errYapePhone" class="text-xs text-danger mt-1 hidden"></p>
                      </div>
                      <div class="text-sm text-slate-500">Escanea este QR en tu app de pagos (QR estático de ejemplo).</div>
                      <div class="mt-2">
                        <!-- Simple SVG placeholder como QR (no funcional) -->
                        <div class="w-40 h-40 bg-white p-3 rounded-md inline-block shadow">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 120" class="w-full h-full">
                            <rect width="120" height="120" fill="#fff"/>
                            <rect x="8" y="8" width="36" height="36" fill="#000"/>
                            <rect x="76" y="8" width="36" height="36" fill="#000"/>
                            <rect x="8" y="76" width="36" height="36" fill="#000"/>
                            <rect x="50" y="50" width="20" height="20" fill="#000"/>
                          </svg>
                        </div>
                      </div>
                    </div>

                    <div class="pt-3 border-t border-slate-100 flex items-center justify-between gap-3">
                      
                      <div class="flex items-center gap-3">
                        <button id="submitBtn" type="submit" class="px-4 py-2 rounded-md text-white bg-cyan-500 hover:bg-cyan-600 font-semibold flex items-center gap-2">
                          <span id="btnText">Pagar ahora</span>
                          <span id="btnLoader" class="hidden"><span class="spinner"></span></span>
                        </button>
                      </div>
                    </div>

                    <div id="resultMessage" class="mt-3 text-sm hidden"></div>
                  </form>
                </section>
              </section>

              <!-- SIDE -->
              <aside class="side-column lg:col-span-1 space-y-4">
                <div class="glass p-4 bg-white rounded-lg shadow">
                  <h3 class="text-sm font-semibold text-slate-800">Panel rápido</h3>
                  <p class="text-xs text-slate-500 mt-1">Resumen del servicio seleccionado</p>
                  <div class="mt-3 space-y-2 text-sm">
                    <div><span class="text-slate-600">Servicio:</span> <strong id="sideSvc" th:text="${pago != null ? (pago.servicioDescripcion != null ? pago.servicioDescripcion : pago.categoriaNombre) : '—'}">—</strong></div>
                    <div><span class="text-slate-600">Costo:</span> <strong id="sideCost" th:text="${pago != null ? ('S/ ' + pago.monto) : 'S/ 0.00'}">S/ 0.00</strong></div>
                    <div><span class="text-slate-600">Fecha:</span> <strong id="sideDate" th:text="${pago != null && pago.servicioFechaFinalizacion != null ? #temporals.format(pago.servicioFechaFinalizacion,'dd/MM/yyyy') : ''}">—</strong></div>
                  </div>
                  <div class="mt-4">
                    <a href="/" class="w-full inline-block text-center px-3 py-2 rounded-md border border-slate-200 bg-white text-sm">Volver</a>
                  </div>
                </div>
              </aside>
            </main>

            <!-- Toast / notificación breve -->
            <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>

            <script>
              const $ = s => document.querySelector(s);
              const $$ = s => Array.from(document.querySelectorAll(s));
              const btns = $$('.method-btn');
              const panels = { tarjeta: $('#panel-tarjeta'), yape: $('#panel-yape') };
              // Ensure toast is hidden on load (in case it was visible)
              const _toast = $('#toast'); if(_toast) _toast.classList.add('hidden');

              function setMethod(m){
                btns.forEach(b=>b.classList.toggle('method-active', b.dataset.method===m));
                Object.keys(panels).forEach(k=> panels[k].classList.toggle('hidden', k !== m));
                hideErrors();
                $('#btnText').textContent = m === 'tarjeta' ? 'Pagar con tarjeta' : 'Pagar con Yape';
              }
              btns.forEach(b=>b.addEventListener('click', ()=>setMethod(b.dataset.method)));
              setMethod('tarjeta');

              function hideErrors(){ $$('.text-danger').forEach(n=>n.classList.add('hidden')); }
              function showError(id,msg){ const el=document.getElementById(id); if(el){ el.textContent=msg; el.classList.remove('hidden'); el.style.color='#dc2626'; }}

              function validExpiry(mmYY){ if(!mmYY) return false; const parts=mmYY.split('/'); if(parts.length!==2) return false; const mm=parseInt(parts[0],10), yy=parseInt(parts[1],10); if(isNaN(mm)||isNaN(yy)) return false; if(mm<1||mm>12) return false; const now=new Date(); const curYY=now.getFullYear()%100; const curMM=now.getMonth()+1; if(yy<curYY) return false; if(yy===curYY && mm<curMM) return false; return true; }

              // En el campo de tarjeta solo permitir dígitos y máximo 16 caracteres
              $('#cardNumber')?.addEventListener('input', (e)=>{
                const cleaned = e.target.value.replace(/\D/g, '').slice(0,16);
                e.target.value = cleaned;
                $('#cardLast4').textContent = cleaned.length>=4?cleaned.slice(-4):'—';
              });
              $('#cardExpiry')?.addEventListener('input',(e)=>{ let v=e.target.value.replace(/\D/g,'').slice(0,4); if(v.length>2) v=v.slice(0,2)+'/'+v.slice(2); e.target.value=v; });

              // Amount field: allow comma or dot, but validate as positive number and <= 100000
              function parseAmount(v){ if(!v) return NaN; v = v.replace(',', '.').replace(/[^0-9.]/g,''); return parseFloat(v); }

              $('#paymentForm').addEventListener('submit', async (ev)=>{
                ev.preventDefault(); hideErrors(); $('#resultMessage').classList.add('hidden'); $('#resultMessage').textContent='';
                const method = btns.find(b=>b.classList.contains('method-active'))?.dataset.method || 'tarjeta';
                const nombre = $('#clienteNombre').value.trim();
                if(!nombre){ showError('errNombre','Nombre obligatorio'); return; }

                const amountRaw = $('#amountInput').value.trim();
                const amount = parseAmount(amountRaw);
                if(isNaN(amount) || amount <= 0){ showError('errAmount','Ingresa un monto válido mayor a 0'); return; }
                if(amount > 100000){ showError('errAmount','El monto es demasiado alto'); return; }

                if(method==='tarjeta'){
                  const card = $('#cardNumber').value.replace(/\s+/g,'');
                  if(!/^\d{16}$/.test(card)){ showError('errCard','Ingrese exactamente 16 dígitos'); return; }
                }

                if(method==='yape'){
                  const phone = $('#yapePhone').value.trim(); if(phone && !/^[9]\d{8}$/.test(phone)){ showError('errYapePhone','Número Yape inválido'); return; }
                }

                // Simulación: mostrar loader y luego notificación
                $('#submitBtn').disabled=true; $('#btnLoader').classList.remove('hidden'); $('#btnText').textContent='Procesando...';
                try{
                  await new Promise(r=>setTimeout(r, 500));
                  // Mostrar notificación de pago exitoso
                  const toast = $('#toast'); toast.textContent = '✅ Pago exitoso'; toast.classList.remove('hidden');
                  $('#resultMessage').classList.remove('hidden'); $('#resultMessage').style.color='#16a34a'; $('#resultMessage').textContent = '✅ Pago exitoso.';

                  // Si hay un pago pendiente en la página, notificar al backend para marcarlo como PAGADO
                  const pagoId = document.getElementById('currentPagoId')?.value;
                  async function markPago(id){
                    if(!id) return null;
                    try{
                      // CSRF support: read token/meta if present
                      const metaToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
                      const metaHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content') || 'X-CSRF-TOKEN';
                      const headers = { 'Content-Type': 'application/json' };
                      if(metaToken) headers[metaHeader] = metaToken;
                      const res = await fetch(`/api/pagos/${encodeURIComponent(id)}/pagar`, { method: 'POST', headers, credentials: 'same-origin' });
                      if(!res.ok) throw new Error('HTTP ' + res.status);
                      return await res.json();
                    }catch(ex){ console.warn('No se pudo marcar pago en backend:', ex); return null; }
                  }

                  await markPago(pagoId);
                  // Redirigir al inicio después de mostrar el toast
                  setTimeout(()=>{ window.location.href = '/'; }, 900);
                }catch(e){ $('#resultMessage').classList.remove('hidden'); $('#resultMessage').style.color='#dc2626'; $('#resultMessage').textContent = '❌ Error en la simulación.'; }
                finally{ $('#submitBtn').disabled=false; $('#btnLoader').classList.add('hidden'); setMethod(method); $('#btnText').textContent = method==='tarjeta' ? 'Pagar con tarjeta' : 'Pagar con Yape'; }
              });
            </script>
          </body>
          </html>